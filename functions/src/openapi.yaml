openapi: 3.0.3
info:
  title: CrowdPM API
  version: 1.0.0
  description: >
    API used by CrowdPM to manage devices and retrieve pollution measurements.
    Error responses use a normalized JSON format with a required `error` field and
    optional `message`. The `error_description` alias is still emitted for compatibility
    and is deprecated.
  license:
    name: Proprietary
    url: https://crowdpmplatform.web.app
servers:
  - url: https://crowdpmplatform.web.app
    description: Production
  - url: http://127.0.0.1:5001/demo-crowdpm/us-central1/crowdpmApi
    description: Local development (Firebase emulator)
security: []
paths:
  /health:
    get:
      operationId: healthCheck
      summary: Health check
      description: Returns 200 when the API is ready to receive traffic.
      security: []
      responses:
        '200':
          description: Service is healthy.
        '400':
          description: Malformed request.
  /device/start:
    post:
      operationId: startDevicePairing
      summary: Start device pairing
      description: >
        Called by a headless node to begin the pairing flow. The node supplies its
        ephemeral Ed25519 public key (`pub_ke`) along with hardware metadata and
        receives a `device_code` + human-readable `user_code`. A human must visit
        `/activate` to approve the request before the device can continue.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [pub_ke, model, version]
              properties:
                pub_ke:
                  type: string
                  description: Base64url-encoded Ed25519 public key that will be used with DPoP during pairing.
                model:
                  type: string
                  example: rpi-node
                version:
                  type: string
                  example: 1.2.3
                nonce:
                  type: string
                  description: Optional client-provided nonce for idempotency.
      responses:
        '200':
          description: Pairing session created.
          content:
            application/json:
              schema:
                type: object
                required: [device_code, user_code, verification_uri, poll_interval, expires_in]
                properties:
                  device_code:
                    type: string
                    description: 128-bit opaque identifier used by the device when polling.
                  user_code:
                    type: string
                    description: Human-readable code displayed to the operator.
                  verification_uri:
                    type: string
                    format: uri
                    description: URL where the human completes activation (`/activate`).
                  verification_uri_complete:
                    type: string
                    format: uri
                    description: Deep link that includes the user code in the query string.
                  poll_interval:
                    type: integer
                    description: Minimum seconds between token polls.
                  expires_in:
                    type: integer
                    description: Lifetime of the device and user codes in seconds.
        '400':
          description: Invalid pairing request.
        '429':
          description: Rate limited.
  /device/token:
    post:
      operationId: pollPairingToken
      summary: Poll for a registration token
      description: >
        Called by the device after the human approves pairing. Requires a DPoP proof bound
        to the `pub_ke` submitted to `/device/start`. While the human has not yet approved,
        the endpoint returns `authorization_pending`. After approval it returns a short-lived
        `registration_token` JWT that can be redeemed via `/device/register`.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [device_code]
              properties:
                device_code:
                  type: string
      responses:
        '200':
          description: Registration token issued.
          content:
            application/json:
              schema:
                type: object
                required: [registration_token, expires_in]
                properties:
                  registration_token:
                    type: string
                    description: JWT scoped to the `device_register` audience.
                  expires_in:
                    type: integer
                    description: Token lifetime in seconds.
        '400':
          description: Session pending, expired, or invalid.
  /device/register:
    post:
      operationId: completeDeviceRegistration
      summary: Register a device identity
      description: >
        Exchanges a `registration_token` for a long-lived device identity. The caller must
        present the bearer token in `Authorization: Bearer` *and* a DPoP proof bound to the
        ephemeral key (`Ke`). The body must include the device's long-term Ed25519 key (`Kl`)
        as a JWK.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                jwk_pub_kl:
                  type: object
                  description: Ed25519 JWK representing the device's long-term key.
                csr:
                  type: string
                  description: Optional PKCS#10 CSR (not yet supported).
      responses:
        '200':
          description: Device registered.
          content:
            application/json:
              schema:
                type: object
                required: [device_id, jwk_pub_kl, issued_at]
                properties:
                  device_id:
                    type: string
                  jwk_pub_kl:
                    type: object
                  issued_at:
                    type: integer
                    description: UNIX timestamp (seconds) when the device record was created.
        '400':
          description: Invalid request payload.
        '401':
          description: Missing/invalid registration token or DPoP proof.
        '403':
          description: Session not authorized for this account.
  /device/access-token:
    post:
      operationId: issueDeviceAccessToken
      summary: Issue a DPoP-bound device access token
      description: >
        Exchanges proof-of-possession of the registered long-term key (`Kl`) for a short-lived
        access token scoped to ingest APIs. Requires a DPoP proof bound to `Kl`.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [device_id]
              properties:
                device_id:
                  type: string
                scope:
                  type: array
                  items:
                    type: string
                  description: Optional scopes (defaults to `ingest.write`).
      responses:
        '200':
          description: Access token issued.
          content:
            application/json:
              schema:
                type: object
                required: [access_token, token_type, expires_in, device_id]
                properties:
                  access_token:
                    type: string
                  token_type:
                    type: string
                    example: DPoP
                  expires_in:
                    type: integer
                  device_id:
                    type: string
        '401':
          description: Missing or invalid DPoP proof.
        '403':
          description: Device not active.
  /v1/devices:
    get:
      operationId: listDevices
      summary: List devices
      description: >
        Returns the devices the authenticated caller can access. Devices may be
        shared with multiple Firebase users, and the caller only receives entries
        where their UID is a member.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Devices returned.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Device'
        '401':
          description: Authentication required.
    post:
      summary: Register a device
      description: >
        Registers a new device for the authenticated user. The device inherits the
        requesting user's Firebase UID as its owner.
      operationId: registerDevice
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterDeviceRequest'
      responses:
        '201':
          description: Device registered.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeviceRegistrationResponse'
        '400':
          description: Invalid request payload.
        '401':
          description: Missing or invalid bearer token.
  /v1/devices/{id}/revoke:
    post:
      operationId: revokeDevice
      summary: Revoke a device
      description: >
        Immediately revokes a device owned by the caller. Revocation tears down active access
        tokens and prevents future ingest requests until the node is re-registered.
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Device revoked.
        '401':
          description: Missing or invalid bearer token.
        '403':
          description: Caller does not own the device.
        '404':
          description: Device not found.
  /v1/device-activation:
    get:
      operationId: getActivationSession
      summary: Fetch activation session
      description: >
        Returns metadata about a pending pairing session so the user can verify the request
        before approving it. Requires a signed-in Firebase user.
      security:
        - BearerAuth: []
      parameters:
        - name: user_code
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Pending pairing session.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActivationSession'
        '401':
          description: Missing or invalid bearer token.
        '404':
          description: Session not found.
  /v1/device-activation/authorize:
    post:
      operationId: authorizeActivationSession
      summary: Approve a pending device
      description: >
        Associates a pending pairing session with the caller's account. Accounts with MFA
        enabled must satisfy a fresh second factor before this endpoint succeeds.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user_code]
              properties:
                user_code:
                  type: string
      responses:
        '200':
          description: Device authorized.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActivationSession'
        '401':
          description: Missing credentials or MFA requirement not satisfied.
        '404':
          description: Session not found.
  /v1/measurements:
    get:
      operationId: getDeviceMeasurements
      summary: Query measurements
      description: >
        Returns measurements for a device within an inclusive time window. Missing or invalid
        parameters result in an empty array. Only authenticated callers who own the device
        (via `ownerUserIds`) may retrieve its data.
      security:
        - BearerAuth: []
      parameters:
        - name: device_id
          in: query
          required: true
          schema:
            type: string
          description: Identifier of the device being queried.
        - name: pollutant
          in: query
          required: false
          schema:
            type: string
            enum: [pm25]
            default: pm25
          description: Pollutant filter. Only `pm25` is currently supported.
        - name: t0
          in: query
          required: true
          schema:
            type: string
            format: date-time
          description: Inclusive start timestamp in ISO-8601 format.
        - name: t1
          in: query
          required: true
          schema:
            type: string
            format: date-time
          description: Inclusive end timestamp in ISO-8601 format.
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 5000
            default: 2000
          description: >
            Maximum number of measurements to return. Higher values may be truncated.
      responses:
        '200':
          description: Matching measurements.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Measurement'
        '400':
          description: Invalid combination of query parameters. Currently returns an empty array.
        '401':
          description: Missing or invalid bearer token.
        '403':
          description: Caller does not have access to the requested device.
  /v1/admin/devices/{id}/suspend:
    post:
      operationId: suspendDevice
      summary: Suspend a device
      description: >
        Marks a device as suspended. Suspended devices cannot submit new measurements.
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Identifier of the device to suspend.
      responses:
        '204':
          description: Device suspended.
        '401':
          description: Missing or invalid bearer token.
        '403':
          description: Caller lacks permission to suspend the device.
  /v1/admin/ingest-smoke-test:
    post:
      operationId: runIngestSmokeTest
      summary: Run ingest smoke test
      description: >
        Seeds synthetic measurements and invokes the ingest pipeline for diagnostics.
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IngestSmokeTestRequest'
      responses:
        '200':
          description: Smoke test completed.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestSmokeTestResponse'
        '400':
          description: Invalid smoke test request.
        '500':
          description: Smoke test failed.
        '401':
          description: Missing or invalid bearer token.
        '403':
          description: Caller lacks permission to run smoke tests.
  /v1/admin/ingest-smoke-test/cleanup:
    post:
      operationId: cleanupIngestSmokeTest
      summary: Clean up ingest smoke test devices
      description: >
        Removes seeded measurement data and deletes generated ingest files.
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IngestCleanupRequest'
      responses:
        '200':
          description: Cleanup completed.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestCleanupResponse'
        '400':
          description: Invalid cleanup request.
        '401':
          description: Missing or invalid bearer token.
        '403':
          description: Caller lacks permission to clean up smoke tests.
  /v1/batches:
    get:
      operationId: listBatches
      summary: List recent ingest batches
      description: >
        Returns the most recent batches for each device the authenticated caller owns (up to 10 per device).
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Batch summaries returned.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BatchSummary'
        '401':
          description: Missing or invalid bearer token.
  /v1/batches/{deviceId}/{batchId}:
    get:
      operationId: getBatchDetail
      summary: Retrieve batch detail
      description: >
        Returns the stored ingest payload for a specific batch belonging to a device the caller owns.
      security:
        - BearerAuth: []
      parameters:
        - name: deviceId
          in: path
          required: true
          schema:
            type: string
          description: Device identifier associated with the batch.
        - name: batchId
          in: path
          required: true
          schema:
            type: string
          description: Ingest batch identifier.
      responses:
        '200':
          description: Batch detail returned.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchDetail'
        '401':
          description: Missing or invalid bearer token.
        '403':
          description: Caller does not own the referenced device.
        '404':
          description: Device or batch not found, or payload unavailable.
  /v1/user/settings:
    get:
      operationId: getUserSettings
      summary: Retrieve user settings
      description: Returns the ingest preferences configured for the authenticated user.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User settings returned.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserSettings'
        '401':
          description: Missing or invalid bearer token.
    put:
      operationId: updateUserSettings
      summary: Update user settings
      description: Sets the preferences applied to new batches created by the authenticated user.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserSettings'
      responses:
        '200':
          description: Updated settings returned.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserSettings'
        '400':
          description: Invalid settings payload.
        '401':
          description: Missing or invalid bearer token.
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    ErrorResponse:
      type: object
      description: >
        Standard error payload emitted by API routes and gateway handlers.
        Endpoint-specific metadata (for example `details`, `poll_interval`,
        `retry_after`, or `forbiddenDeviceIds`) may be present.
      required:
        - error
      properties:
        error:
          type: string
          description: Machine-readable lower_snake_case error code.
        message:
          type: string
          description: Human-readable error detail.
        error_description:
          type: string
          deprecated: true
          description: Deprecated alias for `message`.
      additionalProperties: true
    DeviceStatus:
      type: string
      enum:
        - ACTIVE
        - SUSPENDED
    Device:
      type: object
      description: A registered CrowdPM device.
      properties:
        id:
          type: string
          description: Device identifier.
        name:
          type: string
          description: Friendly name supplied by the owner.
        ownerUserId:
          type: string
          description: Primary Firebase UID associated with the device. Legacy field retained for backwards compatibility.
        ownerUserIds:
          type: array
          description: All Firebase UIDs that can access the device.
          items:
            type: string
          minItems: 1
        publicDeviceId:
          type: string
          description: Raw device identifier provided by the owner (before namespacing).
        ownerScope:
          type: string
          description: Slugged segment derived from the owner UID that is prepended to device IDs for uniqueness.
        status:
          $ref: '#/components/schemas/DeviceStatus'
        createdAt:
          type: string
          format: date-time
          description: Timestamp when the device record was created.
        location:
          $ref: '#/components/schemas/Location'
      required:
        - id
        - name
        - ownerUserId
        - status
        - createdAt
    ActivationSession:
      type: object
      description: Metadata about a pending pairing session.
      properties:
        device_code:
          type: string
        user_code:
          type: string
        model:
          type: string
        version:
          type: string
        fingerprint:
          type: string
          description: First bytes of the Ke hash, used for human verification.
        status:
          type: string
          enum: [pending, authorized, redeemed, expired]
        requested_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        requester_ip:
          type: string
          nullable: true
        requester_asn:
          type: string
          nullable: true
        poll_interval:
          type: integer
        authorized_account:
          type: string
          nullable: true
        viewer_account:
          type: string
          nullable: true
      required:
        - device_code
        - user_code
        - model
        - version
        - status
        - requested_at
        - expires_at
    Location:
      type: object
      description: Latitude and longitude in decimal degrees.
      properties:
        latitude:
          type: number
          format: double
          minimum: -90
          maximum: 90
        longitude:
          type: number
          format: double
          minimum: -180
          maximum: 180
      required:
        - latitude
        - longitude
    RegisterDeviceRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 1
          example: CrowdPM Sensor - Home
          description: Friendly name to display in dashboards.
    DeviceRegistrationResponse:
      type: object
      required:
        - id
      properties:
        id:
          type: string
          description: Newly generated device identifier.
    Measurement:
      type: object
      description: Individual measurement captured for a device.
      properties:
        id:
          type: string
          description: Measurement document identifier.
        deviceId:
          type: string
          description: Device identifier.
        pollutant:
          type: string
          enum: [pm25]
        value:
          type: number
          format: float
        unit:
          type: string
          nullable: true
          description: Units reported by the sensor (for example `µg/m³`).
        lat:
          type: number
          format: double
        lon:
          type: number
          format: double
        altitude:
          type: number
          format: double
          nullable: true
        precision:
          type: integer
          nullable: true
          description: Sensor precision indicator when provided.
        timestamp:
          type: string
          format: date-time
          description: Measurement timestamp in ISO-8601 format.
        flags:
          type: integer
          nullable: true
          description: Optional quality flags bitmask.
      required:
        - id
        - deviceId
        - pollutant
        - value
        - lat
        - lon
        - timestamp
    IngestPoint:
      type: object
      required:
        - device_id
        - pollutant
        - value
        - timestamp
      properties:
        device_id:
          type: string
        pollutant:
          type: string
          enum: [pm25]
        value:
          type: number
          format: float
        unit:
          type: string
        lat:
          type: number
          format: double
        lon:
          type: number
          format: double
        altitude:
          type: number
          format: double
          nullable: true
        precision:
          type: integer
          nullable: true
        timestamp:
          type: string
          format: date-time
        flags:
          type: integer
          nullable: true
    IngestBody:
      type: object
      properties:
        device_id:
          type: string
        points:
          type: array
          items:
            $ref: '#/components/schemas/IngestPoint'
    IngestPointOverrides:
      type: object
      description: Overrides applied to each generated point.
      additionalProperties: false
      properties:
        device_id:
          type: string
        pollutant:
          type: string
          enum: [pm25]
        value:
          type: number
          format: float
        unit:
          type: string
        lat:
          type: number
          format: double
        lon:
          type: number
          format: double
        altitude:
          type: number
          format: double
          nullable: true
        precision:
          type: integer
          nullable: true
        timestamp:
          type: string
          format: date-time
        flags:
          type: integer
          nullable: true
    IngestSmokeTestRequest:
      type: object
      properties:
        deviceId:
          type: string
          description: Device identifier to seed; defaults to a generated ID.
        payload:
          $ref: '#/components/schemas/IngestBody'
        pointOverrides:
          $ref: '#/components/schemas/IngestPointOverrides'
        visibility:
          $ref: '#/components/schemas/BatchVisibility'
          description: Overrides the visibility of the generated batch; defaults to the caller's user setting.
    IngestSmokeTestResponse:
      type: object
      properties:
        accepted:
          type: boolean
          description: Indicates whether the payload was accepted for processing.
        batchId:
          type: string
        deviceId:
          type: string
        storagePath:
          type: string
        payload:
          $ref: '#/components/schemas/IngestBody'
        points:
          type: array
          items:
            $ref: '#/components/schemas/IngestPoint'
        visibility:
          $ref: '#/components/schemas/BatchVisibility'
        seededDeviceId:
          type: string
        seededDeviceIds:
          type: array
          items:
            type: string
      required:
        - accepted
        - batchId
        - deviceId
        - storagePath
        - visibility
    BatchVisibility:
      type: string
      description: Controls whether a batch can be surfaced in public interfaces.
      enum:
        - public
        - private
    BatchSummary:
      type: object
      description: Summary metadata for an ingest batch.
      properties:
        batchId:
          type: string
          description: Batch identifier.
        deviceId:
          type: string
          description: Device associated with the batch.
        deviceName:
          type: string
          nullable: true
          description: Friendly device name, if one is set.
        count:
          type: integer
          description: Number of points recorded in the batch.
        processedAt:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when the batch was processed.
        visibility:
          $ref: '#/components/schemas/BatchVisibility'
          description: Visibility designation attached to the batch.
      required:
        - batchId
        - deviceId
        - count
        - visibility
    BatchDetail:
      allOf:
        - $ref: '#/components/schemas/BatchSummary'
        - type: object
          required:
            - points
          properties:
            points:
              type: array
              description: Ingest payload persisted for the batch.
              items:
                $ref: '#/components/schemas/IngestPoint'
    IngestCleanupRequest:
      type: object
      properties:
        deviceId:
          type: string
        deviceIds:
          type: array
          items:
            type: string
    IngestCleanupResponse:
      type: object
      properties:
        clearedDeviceId:
          type: string
          nullable: true
        clearedDeviceIds:
          type: array
          items:
            type: string
    UserSettings:
      type: object
      properties:
        defaultBatchVisibility:
          $ref: '#/components/schemas/BatchVisibility'
          description: Visibility applied to newly created batches when not explicitly specified.
        interleavedRendering:
          type: boolean
          description: Whether the map should render deck.gl interleaved with Google Maps (may be less stable on some GPUs).
      required:
        - defaultBatchVisibility
        - interleavedRendering
